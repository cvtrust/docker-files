FROM californiasvaluedtrust/php:8.2-zts-bullseye

ENV SWOOLE_VERSION=4.8.13
ENV DEBIAN_FRONTEND="noninteractive"

WORKDIR /app


RUN set -xe && \
    apt-get update && \
    apt-get install -y $PHPIZE_DEPS libpq-dev netcat-traditional libsqlite3-dev sqlite3 openssl libssl-dev libcurl4-openssl-dev libpng-dev libjpeg-dev autoconf git && \
    docker-php-ext-configure pdo_pgsql && \
    docker-php-ext-configure gd --with-jpeg && \
    docker-php-ext-install pdo_pgsql sockets pdo_sqlite exif zip gd;

RUN set -xe && \
    curl -LO https://github.com/swoole/swoole-src/archive/v${SWOOLE_VERSION}.tar.gz && \
    tar xzf v${SWOOLE_VERSION}.tar.gz && \
    cd swoole-src-${SWOOLE_VERSION} && \
        phpize && \
        ./configure --enable-openssl --with-openssl-dir=/usr/include/openssl && \
        make -j && \
        make && \
        make install && \
    rm -rf /app/v${SWOOLE_VERSION}.tar.gz /app/swoole-src-${SWOOLE_VERSION} && \
    docker-php-ext-enable swoole
